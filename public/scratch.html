<html>
<head>
  <style>
  canvas {
    position: absolute;
    left: 100;
    top: 100;
  }
  #imageCanvas {z-index: 1}
  #coverCanvas {z-index: 2}
  </style>
</head>
<body>

<canvas id="imageCanvas" width="300" height="300"></canvas>
<canvas id="coverCanvas" width="300" height="300"></canvas>

<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="client.js"></script>

<script>

var IMAGE_URL = 'http://uncovered-proxy.herokuapp.com/image/6885bc64100c07ec425b6902eeb88c6c0fde6f89';
var PREVIEW_URL = 'http://uncovered-proxy.herokuapp.com/mp3-preview/15c7cefeba3b74ff89f1ec93872d951cb88b26f9'

var imageCanvas = document.getElementById("imageCanvas");
var coverCanvas = document.getElementById("coverCanvas");

var imageContext = imageCanvas.getContext('2d');
var coverContext = coverCanvas.getContext('2d');

var width = parseInt($(imageCanvas).attr('width'))
var height = parseInt($(imageCanvas).attr('height'))

var palettized;
var frequencies;

var aj = new audiojumbler();

// load image from data url
var imageObj = new Image();
imageObj.onload = function() {
  imageContext.drawImage(this, 0, 0, width, height);
  var pixels = imageContext.getImageData(0, 0, width, height).data;
  palettized = featuremapping.extractPalettized(pixels, width, height);
  frequencies = featuremapping.extractFrequencies(pixels, width, height);

  // Everything analyzed, start music
  aj.start(PREVIEW_URL);
};
imageObj.crossOrigin="Anonymous";
imageObj.src = IMAGE_URL;

coverContext.fillStyle = "#FF0000";
coverContext.fillRect(0,0,width,height);

var isMouseDown = false;
$(coverCanvas).mousedown(function(e) { isMouseDown = true })
$(coverCanvas).mouseup(function(e) { isMouseDown = false })
$(coverCanvas).mouseout(function(e) { isMouseDown = false })
$(coverCanvas).mousemove(function(e) {
  if (!isMouseDown) return;
  var pos = {
    x: e.offsetX,
    y: e.offsetY
  }
  var strokeSize = 20;

  // Clear the space
  coverContext.clearRect(
    pos.x - strokeSize / 2,
    pos.y-strokeSize/2 ,
    strokeSize,
    strokeSize
  );

  var pixels = coverContext.getImageData(0, 0, width, height).data;

  var pltsums = [];
  var fqsums = [];

  for (var i = 0; i < pixels.length; i += 4) {
    if (pixels[i] == 0) {
      var pixelix = i / 4;
      for (k in palettized) {
        var plt = palettized[k];
        pltsums[k] = pltsums[k] ? pltsums[k] + plt[pixelix] : plt[pixelix];
      }
      for (m in frequencies) {
        var fq = frequencies[m];
        fqsums[m] = fqsums[m] ? fqsums[m] + fq[pixelix] : fq[pixelix];
      }
    }
  }

  console.log(pltsums);
  console.log(fqsums);

  aj.setParams(pltsums, fqsums);
//  aj.setParams([1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], fqsums);

})
</script>
</body>

</html>
